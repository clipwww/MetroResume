<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
		<!--width=device-width為適應各式裝置螢幕大小 initial-scale=1為初始比例-->
		<meta http-equiv="X-UA-Compatible" content="IE=edge"> 
		<!--X-UA-Compatible設置IE兼容模式；有什麼最新的版本IE，就用什麼版本的標準模式。-->
		<meta name="description" content="MetroResume">
		<title>Komica Reader</title>
		<link href="image/favicon.ico" rel="icon">
		<link href="css/reset.css" rel="stylesheet"> <!--ResetCSS-->	
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/Animate.css" rel="stylesheet">
		<link id="myCss" href="css/komicaReader2.css" rel="stylesheet"><!--自己寫的css要最後一個讀取-->
		<script src="js/jquery-2.2.0.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script>
		$(function(){

			$("#menuIcon").click(function(){
				$("#menu").animate({"left":"0px"}, 500);			
			});
			$("#main, #menu li, #menu li#close").click(function(){
				$("#menu").animate({"left":"-200px"}, 500);			
			});

			$("#menu li[name]").click(readKanban);

			$("#menu li#change").click(function(){
				var oldCss = $("#myCss").attr("href")
				if( oldCss === "css/komicaReader.css" ){
					$("#myCss").attr("href","css/komicaReader2.css");
				}else{
					$("#myCss").attr("href","css/komicaReader.css");
				}	
			});

			$("#menu li#showImg").click(function(){
				$("#jumpImageS div").text("");
				$.each(ImagesS, function(i, data){
					$("<img/>",{
						"src": data,
						"alt": ImagesB[i]
					}).appendTo('#jumpImageS div');
				});
				$("#jumpImageS").fadeIn(500);
				$("html, body").animate({"scrollTop":"0px"}, 500);
			});
			$("#jumpImageS").on({
				click: function(){
					var imgSrc = $(this).attr("alt");
		    		$("#jumpImage img").attr("src",imgSrc);
		    		$("#jumpImage").fadeIn(500);
				}
			}, "img");
			$("#jumpImageS button").click(function(){
				$("#jumpImageS").fadeOut(500);
			});

		    $("#main").on({
		    	mouseenter: function(){
		    		$(this).css("border-color","red");
		    	},
		    	mouseleave: function(){
		    		$(this).css("border-color","white");
		    	},
		    	click: readCommand
		    },".box");

		    $("#main").on({
		    	mouseenter: function(){
		    		$(this).css("border-color","#F00");
		    	},
		    	mouseleave: function(){
		    		$(this).css("border-color","white");
		    	},
		    	click: function(){
		    		var imgSrc = $(this).parent("a").attr("href");
		    		$("#jumpImage img").attr("src",imgSrc);
		    		$("#jumpImage").fadeIn(500);
		    		return false;
		    	}	    	
		    }, ".miniBox a img");

		    $("#jumpImage").click(function(){
		    	$("#jumpImage").fadeOut(500);
		    });

		    $("#main").on({
		    	click: readList
		    }, "#listLink");

		    $("#downBtn").click(function(){
		    	var bottomTop = $("html").height() - $(window).height();
		    	$("html, body").animate({"scrollTop":bottomTop}, 800);
		    });
		    $("#upBtn").click(function(){
		    	$("html, body").animate({"scrollTop":0}, 800);
		    });
		    $(window).scroll(function() {
		    	var BottomH = $("html").height() - $(window).height();
		    	if( $(window).scrollTop() === BottomH ){
		    		$("#downBtn").addClass("flipOutX").fadeOut(500,function(){
		    			$(this).removeClass("flipOutX");
		    		});
		    	}else{
		    		$("#downBtn").show();
		    	}
		    	if( $(window).scrollTop() !== 0 ){
		    		$("#upBtn").show();
		    	}else{
		    		$("#upBtn").addClass("bounceOutRight").fadeOut(500,function(){
		    			$(this).removeClass("bounceOutRight");
		    		});
		    	}
		    });


			function readKanban(){
				// find some demo xml - DuckDuckGo is great for this
				var URL = $(this).attr("name");
				// build the yql query. Could be just a string - I think join makes easier reading
				var yqlURL = [
			    	"http://query.yahooapis.com/v1/public/yql",
			        "?q=" + encodeURIComponent("select * from xml where url='" + URL + "'"),
			        "&format=json&callback=?"
			    ].join("");
				// Now do the AJAX heavy lifting  
				var n = URL.indexOf("rss",0);
				URL = URL.substring(0, n);

				$("#main").text("");

			    $.getJSON(yqlURL, function(data){
			    	if(data.query.results === null ){
			    		$("#main").append('<h1>連線失敗惹<br/>(｡・ ω<)ゞ てへぺろ❤</h1><h1>應該是連線失敗，吧？<br/>不然就是其他某種可能的原因ㄏㄏ</h1><h1>總之</h1><h1>(´◓Д◔`) 哇幹!!<br/>( っค้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้้c )</h1>');
			    		return false;
			    	}
			        var komica = data.query.results.rss.channel;
			        $("header span").text(komica.title);

			        var komicaHTML = "";
			        var temp = "pixmicat.php?mode=module&load=mod_threadlist&page=0&sort=date";
			        komicaHTML += "<button id=\"listLink\" class=\"btn btn-primary btn-block\" name=\""+URL+temp+"\">主題列表</button>";

			        var count = 0;
			        $.each(komica.item, function(i, comData){
			       		var num_of_cut = comData.title.lastIndexOf("No");
			        	var komicaTitle = comData.title.substring(0,num_of_cut);
			        	num_of_cut = comData.pubDate.lastIndexOf("+0800");
			        	komicaTime = comData.pubDate.substring(0,num_of_cut);
			        	
			        	komicaHTML += "<div class=\"col-sm-6\">";
			        	komicaHTML += "<a class=\"noneAtag\" href='"+ comData.link +"'><div class='box'>";
			        	komicaHTML += "<p>" + komicaTitle + "</p>";
			        	komicaHTML += "<p>" + comData.description + "</p>";
			        	komicaHTML += "<hr/><span>Update："+ komicaTime + "</span></div></a></div>";

			        	if( i%2 === 1){
			        		$("<div/>",{ 
			        			"id":"main"+count,
			        			"class":"row"
			        		}).appendTo("#main");

			        		$("#main"+ count).append(komicaHTML);
			        		
			        		komicaHTML=" ";

			        		count++;
			        	}//end if
			        });//end each
			    });//end getJSON
			}//end function

			var kurl;
			var ImagesB = new Array();
			var ImagesS = new Array();
		    function readCommand(){	
		    	var contents = new Array();
	    		var URL = $(this).parent("a").attr("href");
	    		var yqlURL = [
			    	"http://query.yahooapis.com/v1/public/yql",
			        "?q=" + encodeURIComponent("select * from xml where url='" + URL + "'"),
			        "&format=json&callback=?"
			    ].join("");

			    kurl = [
				    	"http://query.yahooapis.com/v1/public/yql",
				        "?q=" + encodeURIComponent("select * from html where url='" + URL + "'"),
				        "&format=xml"
				].join("");	

				$("#main").text(" "); 
				ImagesB.length = 0;
				ImagesS.length = 0;

				$.get(kurl, function(data){
					var komicaXML = data.documentElement.getElementsByTagName("body")[0].getElementsByTagName("form")[1].getElementsByTagName("div")[0].getElementsByTagName("div");

					var count=0;
					$.each(komicaXML,function(i, data){
						if( (i+1) % 3 ===0 ){	
							contents[count] = data.innerHTML;
							count++;
						}
					});

				    $.getJSON(yqlURL, function(data){
				        var komica = data.query.results.html.body.div[1].form.div[0];
				        var upo;
				        var title;
				        var time;
				        var id;
				        var komicaHTML="";

				        $("header span").text(title);
	 
				        $.each(komica.div, function(i, comData){
				        	upo = komica.div[i].div;
					        title = upo.label.span[0].content;
					        time = upo.label.content;
					        id = upo.input.id; 
					       

					        if( i === 0 ){
					        	komicaHTML = "<div class=\"row\"><div id='r"+ id +"' class=\"col-sm-12 miniBox\">";
					        }else{
					        	komicaHTML += "<div id='r"+ id +"' class=\"col-sm-10 miniBox\">";
					        }
				       	    if( upo.label.a !== undefined ){
				       	    	var mail = upo.label.a.href; 
				       	    	time = time.split("ID:");
				       	    	time_ID = upo.label.a.content

				       	    	komicaHTML += "<span>"+time[0]+"ID:<a href='"+ mail +"'>"+ time_ID +"</a>]<span>";
				       	    	komicaHTML += "<p>島民NO."+ id +"－";
				       	    }else{
								komicaHTML += "<span>"+time+"<span><p>島民NO."+ id +  "－";
				       	    }// end if

				       		komicaHTML += " " + title +"</p>";

				       		if( Array.isArray(upo.a) ){
					        	var imgHrefB = upo.a[1].href;

				       			if( imgHrefB.indexOf(".gif") !== -1 ){
				       				imgHrefS = imgHrefB;//代表為gif
				       			}else{
				       				imgHrefS = imgHrefB.replace("src","thumb");
				       				imgHrefS = imgHrefS.replace(".jpg","s.jpg");
				       				imgHrefS = imgHrefS.replace(".png","s.jpg");
				       			}

				        		komicaHTML += "<a href=\""+imgHrefB+"\">";
				       			komicaHTML += "<img src='"+imgHrefS+"' alt=\"komicaimg\" /></a>";

				       			ImagesB.push(imgHrefB);
				       			ImagesS.push(imgHrefS);

					        }// end if

					        komicaHTML += "<p class=\"content\">" + contents[i] + "</p>";
				       		komicaHTML += "</div>";		        

				        });// end each
						komicaHTML += "</div>";
						$("#main").append(komicaHTML);
					    komicaHTML = "";
			    	});//end getJSON					
				}).always(function(){
					$("#jumpImage img").attr("src","image/loading2.gif");
		    		$("#jumpImage").fadeIn(500);
				}).done(function(){
					$("#jumpImage").fadeOut(500);
				}); // end get
			return false;
		    }//end function

			function readList(){
				URL = $(this).attr("name");

				var x=0;
				while(x<2){
					console.log(URL);
					var listURL = [
				    	"http://query.yahooapis.com/v1/public/yql",
				        "?q=" + encodeURIComponent("select * from html where url='" + URL + "'"),
				        "&format=json&callback=?"
				    ].join("");

				    var n = URL.indexOf("pixmicat",0);
					var kanBanUrl = URL.substring(0, n);

					$("#main").text(" "); 

					$.getJSON(listURL, function(data){
						var list = data.query.results.body.div[1].form.table.tbody;
						var listHTML = " ";

						$.each(list.tr, function(i, data){
							if(i){
								var listTitle = data.td[2].a.content;
								var listHref = data.td[2].a.href;
								var reNum = data.td[4];

								listHTML += "<div class=\"col-sm-3\">";
								listHTML += "<a class=\"noneAtag\" href='"+ kanBanUrl + listHref +"'><div class=\"box\">";
								listHTML += "<p class=\"content\">"+ listTitle + "</p><hr/>回應數："+ reNum;
								listHTML += "</div></a></div>";
							}//end if
							if( i % 4 === 0 && i !== 0 ){
								$("<div/>",{
			        				"class":"row"
			        			}).appendTo("#main").append(listHTML);
								listHTML = " ";
							}//end if
						});//end each
							$("<div/>",{
		        				"class":"row"
		        			}).appendTo("#main").append(listHTML);
							listHTML = " ";
					}); //end getJSON
					URL = URL.replace("page=0","page=1");
					x++;
				}//end while
			}//end function    
		});//end read

		function replyhl(id){
			$("#r"+id).css("background-color","rgba(187,209,233,0.5)")
			$("#r"+id).siblings().css("background-color","")
		}	

		</script>
	</head>
	<body>
		<span id="menuIcon" class="glyphicon glyphicon-menu-hamburger"></span>
		<div id="menu">
			<a href="KomicaReader.html" ><img src="image/komicaLogo.jpg" alt="Komica" /></a>
			<ul>
				<li name="http://2cat.or.tl/~tedc21thc/new/rss.xml">新番捏他</li>
				<li name="http://2cat.or.tl/~tedc21thc/live/rss.xml">新番實況</li>
				<!-- <li name="http://2cat.twbbs.org/~tedc21thc/anime/rss.xml">動畫</li> -->
				<li id="showImg" ><hr/><span class="glyphicon glyphicon-picture"></span><br/>顯示本串全部圖片</li>		
				<li id="change"><hr/><span class="glyphicon glyphicon-repeat"></span> 更換配色風格</li>
				<li id="close" ><hr/><span class="glyphicon glyphicon-remove"></span><br/>收起來</li>
			</ul>
		</div>

		<header>
			<span>島民粗乃丸☆</span>
		</header>

		<div id="main" class="container">
			<div class="row">
				<div class="col-xs-8 col-xs-offset-2" style="text-align:center">
					<h1>自我滿足用Komia Reader<h1/>					
				</div>
			</div>
		</div>

		<div id="jumpImage">
			<img src=" " alt="jump!"/>
		</div>

		<div id="jumpImageS">
			<button class="btn btn-block btn-danger glyphicon glyphicon-remove"></button>
			<div></div>
		</div>

		<img id="downBtn" class="animated flipInY" src="image/bottom-button.png" alt="電梯往下"/>
		<img id="upBtn" class="animated bounceInRight" src="image/top-button.png" alt="電梯往上"/>

	</body>
</html>